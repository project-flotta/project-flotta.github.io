<!DOCTYPE html>
<html lang="en">

<head>
  <script id="dpal" src="//www.redhat.com/ma/dpal.js" type="text/javascript"></script>
  <meta charset="utf-8">
  <title>Project Flotta</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="this is meta description">

  

  <!-- ** Plugins Needed for the Project ** -->
  
  <link rel="stylesheet" href="/assets/plugins/bootstrap/bootstrap.min.css">
  
  <link rel="stylesheet" href="/assets/plugins/themify-icons/themify-icons.css">
  
  <link rel="stylesheet" href="/assets/plugins/slick/slick.css">
  

  <link href="/assets/scss/syntax_monokai.css" rel="stylesheet">
  <!-- Main Stylesheet -->
  <link href="/assets/scss/style.css" rel="stylesheet">

  <!--Favicon-->
  <link rel="shortcut icon" href="/assets/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="/assets/images/flotta-logo-stacked.ico " type="image/x-icon">

  <!-- google analytics -->
  

</head>


<body>

  <header class="navigation fixed-top nav-bg">
  <nav class="navbar navbar-expand-lg navbar-dark">
    <a class="navbar-brand font-tertiary h3" href="/">
      
        <img src="/assets/images/flotta-logo.png" alt="Project Flotta" style="height: 60px;">
        
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation"
      aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse text-center" id="navigation">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item active">
          <a class="nav-link" href="/">Home</a>
        </li>
        
          <li class="nav-item ">
            <a class="nav-link" href="/blog.html">Blog</a>
          </li>
        
          <li class="nav-item ">
            <a class="nav-link" href="/documentation/v0_2_0/intro/overview.html">Documentation</a>
          </li>
        
      </ul>
    </div>
  </nav>
</header>


  <section class="section skip_top">
  <div class="container">
    <div class="row">
      <div class="col-lg-4">
        
        
        <ul class="list-group list-group-collapse border-0">
          
          <li class="list-group-item border-0">
            <h5>
              
              Intro
              
            </h5>
            
            <ul class="list-group border-0">
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/intro/overview.html">What is flotta</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/intro/usecases.html">Use cases</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/intro/vs.html">Flotta vs others</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/intro/concepts.html">Concepts</a> </li>
              
            </ul>
            
          </li>
          
          <li class="list-group-item border-0">
            <h5>
              
              Getting started
              
            </h5>
            
            <ul class="list-group border-0">
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/gsg/minikube.html">Minikube</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/gsg/kind.html">Kind</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/gsg/ocp.html">OCP</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/gsg/running_workloads.html">Running workloads</a> </li>
              
            </ul>
            
          </li>
          
          <li class="list-group-item border-0">
            <h5>
              
              Operations
              
            </h5>
            
            <ul class="list-group border-0">
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/operations/requirements.html">System Requirements</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/operations/deployment_options.html">Deployment options</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/operations/configuration.html">Configuration</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/operations/remote_data_store.html">Remote Edge Configuration API</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/operations/observability.html">Observability</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/operations/data_synchronization.html">Data Synchronization</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/operations/troubleshooting.html">Troubleshooting</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/operations/api.html">API reference</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/operations/crd.html">CRD reference</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/operations/host_devices.html">Accessing host devices</a> </li>
              
            </ul>
            
          </li>
          
          <li class="list-group-item border-0">
            <h5>
              
              For developers
              
            </h5>
            
            <ul class="list-group border-0">
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/dev/installation.html">Manual installation & tips</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/dev/guide.html">Development Guide</a> </li>
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/dev/profiling.html">Profiling</a> </li>
              
            </ul>
            
          </li>
          
        </ul>
        <p>Documentation for version: <b>v0.2.0</b></p>
        <ul class="list-group list-group-collapse border-0">
          <li class="list-group-item border-0">
            <h5>Other versions</h5>

            <ul class="list-group border-0">
              
              
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/intro/overview.html"> v0.1.0</a> </li>
              
              
              
              
              <li class="list-group-item border-0"> <a href="/documentation/latest/intro/overview.html"> latest</a> </li>
              
              
              
              
              <li class="list-group-item border-0"> <a href="/documentation/v0_2_0/intro/overview.html"> v0.2.0</a> </li>
              
            </ul>
          </li>

        </ul>
      </div>

      <div class="col-lg-8">
        <div class="documentation content">
          
          

          <p>This document describes how to troubleshoot Flotta in different deployment
modes. It focuses on a full deployment; If you are  looking for a simple way to
experiment, we highly recommend trying out the Getting Started Guides instead.</p>

<p>This guide assumes that you have some knowledge of all components and concepts.</p>

<h2 id="flotta-operator--api-server">Flotta operator &amp; API Server</h2>

<h3 id="edgedevices-are-not-created-when-device-is-on">Edgedevices are not created when device is on.</h3>

<p>This maybe is because
<a href="/documentation/v0_2_0/operations/deployment_options.html#auto_approval_process">AUTO_APPROVAL_PROCESS</a> is set to
false. When this parameter is enabled on the operator, devices can only enrol,
but a human needs to approve the device to land to a specific namespace, labels
or deviceSet.</p>

<h3 id="devices-are-getting-401-responses">Devices are getting 401 responses</h3>

<p>This can be normal, mainly because some heartbeat process is executed before the
system enrols into the cluster. To validate that your certificates are correct,
you need to check the certs used, mainly using the following <code class="language-plaintext highlighter-rouge">openssl</code> command:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>openssl x509 <span class="nt">-noout</span> <span class="nt">-in</span> /etc/pki/consumer/cert.pem <span class="nt">--subject</span>
</code></pre></div></div>

<p>where subject CN should be the DEVICE_ID value.</p>

<p>Those 401 is possible that are heartbeats that are not yet using the right
certificate. On the operator logs, should be easy to find why the certificates
are failing if it’s not in there.</p>

<h3 id="flotta-api-is-not-getting-any-traffic">Flotta API is not getting any traffic</h3>

<p>By default Flotta uses openshift-router, and uses an internal service, so
checking that both service and Ingress route is correct is the way to go.</p>

<p>The best way to check the route is with the following command:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get route <span class="nt">-n</span> flotta flotta-edge-api <span class="nt">-o</span> json | jq <span class="s2">".status"</span>
<span class="o">{</span>
  <span class="s2">"ingress"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"conditions"</span>: <span class="o">[</span>
        <span class="o">{</span>
          <span class="s2">"lastTransitionTime"</span>: <span class="s2">"2022-05-06T10:46:36Z"</span>,
          <span class="s2">"status"</span>: <span class="s2">"True"</span>,
          <span class="s2">"type"</span>: <span class="s2">"Admitted"</span>
        <span class="o">}</span>
      <span class="o">]</span>,
      <span class="s2">"host"</span>: <span class="s2">"project-flotta.io"</span>,
      <span class="s2">"routerName"</span>: <span class="s2">"public"</span>,
      <span class="s2">"wildcardPolicy"</span>: <span class="s2">"None"</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</code></pre></div></div>

<p>And for the service, check that the pod is running as expected:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>-&gt; kubectl get pod <span class="nt">-n</span> flotta <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>flotta-edge-api
NAME                                                  READY   STATUS             RESTARTS   AGE
flotta-edge-api-8649fbb9dc-bt4r9                      1/2     ImagePullBackOff   0          27m
</code></pre></div></div>

<p>As in this example, flotta edge api pod is not ready, and communication is not working as
expected.</p>

<h2 id="device-operations-troubleshooting">Device operations troubleshooting</h2>

<p>All those guides expect that you have access to the edgedevice terminal, so all
the checks are at the device level.</p>

<h3 id="the-device-is-failing-on-tls-handshakes">The device is failing on TLS handshakes</h3>

<p>This can be that the initial certificates are not valid, or CA certificate is
not included in the yggdrasil config. For that, you need to make sure that the
following  entries are added into <code class="language-plaintext highlighter-rouge">/etc/yggdrasil/config.toml</code></p>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">key-file</span> <span class="p">=</span> <span class="s">"/etc/pki/consumer/key.pem"</span>
<span class="py">cert-file</span> <span class="p">=</span> <span class="s">"/etc/pki/consumer/cert.pem"</span>
<span class="py">ca-root</span> <span class="p">=</span> <span class="nn">["/etc/pki/consumer/ca.pem"]</span>
</code></pre></div></div>

<p>And for the register certificate, a client certificate that can only do register
action, so the CN for the certificate is “register”, subject should be similar
to this:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>-&gt; openssl x509 <span class="nt">-noout</span> <span class="nt">-in</span> /tmp/cert.pem <span class="nt">--subject</span>
<span class="nv">subject</span><span class="o">=</span>O <span class="o">=</span> flotta-operator, CN <span class="o">=</span> register, serialNumber <span class="o">=</span> reg-client-ca-p5rp4gwkqt
</code></pre></div></div>

<h3 id="device-is-not-deploying-a-workload">Device is not deploying a workload</h3>

<p>When a device gets a workload, it reports the workload status, so a user can see
what happens with the workloads.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get <span class="nt">-n</span> ny edgedevice camera-ny <span class="nt">-o</span> json | jq <span class="s1">'.status.workloads'</span>
<span class="o">[</span>
  <span class="o">{</span>
    <span class="s2">"lastTransitionTime"</span>: <span class="s2">"2022-05-06T13:19:24Z"</span>,
    <span class="s2">"name"</span>: <span class="s2">"x86-logs"</span>,
    <span class="s2">"phase"</span>: <span class="s2">"Running"</span>
  <span class="o">}</span>,
  <span class="o">{</span>
    <span class="s2">"lastTransitionTime"</span>: <span class="s2">"2022-05-06T13:19:24Z"</span>,
    <span class="s2">"name"</span>: <span class="s2">"camera-rec"</span>,
    <span class="s2">"phase"</span>: <span class="s2">"Running"</span>
  <span class="o">}</span>
<span class="o">]</span>
</code></pre></div></div>

<p>Each workload has the folowing config in the device:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/etc/yggdrasil/device/workloads/$WORKLOADNAME/workload.yaml</code>:  The file that
contains podman workload definition, and is  what uses device agent when it
has difficulties reaching the API server.</li>
  <li>Systemd entry to manage the workload and keep it updated, <code class="language-plaintext highlighter-rouge">ls
/etc/systemd/system/pod-*</code></li>
</ul>

<p>To gather information of non-running workload you can review the following:</p>

<ul>
  <li>Yggdrasil device-worker logs:
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>journalctl <span class="nt">-u</span> yggdrasild
</code></pre></div>    </div>
  </li>
  <li>Last config retrieved by the device-agent and applied:
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> /etc/yggdrasil/device/device-config.json
</code></pre></div>    </div>
  </li>
  <li>The output of <a href="https://docs.podman.io/en/v4.0.0/markdown/podman-pod.1.html">podman pod</a>
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># podman  pod ps</span>
POD ID        NAME        STATUS      CREATED         INFRA ID      <span class="c"># OF CONTAINERS</span>
163da209abd8  camera-rec  Running     26 minutes ago  4fc3c7133c6d  2
58ce7642217b  x86-logs    Running     26 minutes ago  65e7c9dc9f77  2
</code></pre></div>    </div>
  </li>
</ul>

        </div>
      </div>
    </div>
  </div>
</section>

  <!-- footer -->
<footer class="bg-dark footer-section">
  <div class="section">
    <div class="container">
      <div class="row">
        <div class="col-md-4">
          <h5 class="text-light">Email</h5>
          <p class="text-white paragraph-lg font-secondary">flotta@redhat.com</p>
        </div>
        <div class="col-md-4">
          <h5><a href="http://www.redhat.com"><img id="sponsorship" class="footerLogo" src="/assets/images/Logo-Red_Hat-Supported_By-A-Reverse-RGB.svg"></a>.</h5>
        </div>
        <!-- <div class="col-md-4"> -->
        <!--   <h5 class="text-light">Address</h5> -->
        <!--   <p class="text-white paragraph-lg font-secondary"></p> -->
        <!-- </div> -->
      </div>
    </div>
  </div>
  <div class="border-top text-center border-dark py-5">
    <p class="mb-0 text-light"><p>Copyright © 2020 Designed by <a href="https://themefisher.com">Themefisher</a> &amp; Developed by <a href="https://getjekyllthemes.com">Getjekyllthemes</a></p>
</p>
  </div>
</footer>
<!-- /footer -->


<!-- JS Plugins -->

<script src="/assets/plugins/jQuery/jquery.min.js"></script>

<script src="/assets/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/assets/plugins/shuffle/shuffle.min.js"></script>

<script src="/assets/plugins/slick/slick.min.js"></script>


<!-- Main Script -->
<script src="/assets/js/script.js"></script>

<!-- This comes from DTM/DPAL and must be latest entry in body-->
<script type="text/javascript">
  if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
      _satellite.pageBottom();
  }
</script>


<script>
  $(function() {
    return $("h2, h3, h4, h5, h6").each(function(i, el) {
      var $el, icon, id;
      $el = $(el);
      id = $el.attr('id');
      icon = '<i class="ti-link"></i>';
      console.log("test test"+id)
      if (id) {
        return $el.prepend($("<a />").addClass("header-link").attr("href", "#" + id).html(icon));
      }
    });
  });
</script>


</body>

</html>
