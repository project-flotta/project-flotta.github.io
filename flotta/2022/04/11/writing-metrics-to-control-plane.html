<!DOCTYPE html>
<html lang="en">

<head>
  <script id="dpal" src="//www.redhat.com/ma/dpal.js" type="text/javascript"></script>
  <meta charset="utf-8">
  <title>Writing metrics to control plane</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="this is meta description">

  

  <!-- ** Plugins Needed for the Project ** -->
  
  <link rel="stylesheet" href="/assets/plugins/bootstrap/bootstrap.min.css">
  
  <link rel="stylesheet" href="/assets/plugins/themify-icons/themify-icons.css">
  
  <link rel="stylesheet" href="/assets/plugins/slick/slick.css">
  

  <link href="/assets/scss/syntax_monokai.css" rel="stylesheet">
  <!-- Main Stylesheet -->
  <link href="/assets/scss/style.css" rel="stylesheet">

  <!--Favicon-->
  <link rel="shortcut icon" href="/assets/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="/assets/images/flotta-logo-stacked.ico " type="image/x-icon">

  <!-- google analytics -->
  

</head>


<body>

  <header class="navigation fixed-top nav-bg">
  <nav class="navbar navbar-expand-lg navbar-dark">
    <a class="navbar-brand font-tertiary h3" href="/">
      
        <img src="/assets/images/flotta-logo.png" alt="Project Flotta" style="height: 60px;">
        
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation"
      aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse text-center" id="navigation">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item active">
          <a class="nav-link" href="/">Home</a>
        </li>
        
          <li class="nav-item ">
            <a class="nav-link" href="/blog.html">Blog</a>
          </li>
        
          <li class="nav-item ">
            <a class="nav-link" href="/documentation/v0_2_0/intro/overview.html">Documentation</a>
          </li>
        
      </ul>
    </div>
  </nav>
</header>


  <section class="section skip_top">
  <div class="container documentation">
    <div class="row">
      <div class="col-lg-12">
        <h1 class="font-tertiary mb-5">Writing metrics to control plane</h1>
        <p class="font-secondary">Published on Apr 11, 2022 by <span class="text-primary">Yaron Dayagi</span
            class="text-primary"> on <span>guide </span><span>flotta </span></p>
        <div class="content">
          

          <p>Flotta edge devices collect metrics from device’s system and workloads. These metrics are stored locally in the device. How do we get the metrics to the control plane? How can we view the metrics in control plane? These questions are what this blog post is about.</p>

<h2 id="device-metrics---quick-overview">Device metrics - quick overview</h2>

<p>Configuring a device to collect metrics is covered by the <a href="https://project-flotta.github.io/documentation/latest/operations/observability.html">device-metrics user guide</a>. Flotta agent in the device scrapes system and workloads metrics and writes to a local TSDB folder. For system metrics we use <code class="language-plaintext highlighter-rouge">node_exporter</code>. Thanks to that you can see metrics such as <code class="language-plaintext highlighter-rouge">node_memory_MemAvailable_bytes</code>. The local TSDB enforces a retention policy.</p>

<h2 id="prometheus-remote-write-api">Prometheus Remote Write API</h2>

<p><a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#remote_write">Prometheus Remote Write API</a> is an HTTP API that allows a client to write metrics to a remote server (a.k.a. receiver). The <a href="https://prometheus.io/docs/operating/integrations/#remote-endpoints-and-storage">Prometheus Integrations page</a> lists various servers that implement the server side of Remote Write API. Flotta project includes an example for using <a href="https://thanos.io/tip/components/receive.md/#receiver">Thanos</a> as a receiver.</p>

<h2 id="flotta-projects-solution">Flotta project’s solution</h2>

<p>Flotta’s solution is to use the Prometheus Remote Write API for writing to a server in the control plane. Flotta agent, periodically reads from the local TSDB (5 minutes) and writes to a receiver in the control plane. The client in the agent is a reuse of <a href="https://github.com/prometheus/prometheus/tree/main/storage/remote">Prometheus Write Client</a>.
Configuring the agent is explained <a href="https://project-flotta.github.io/documentation/latest/operations/observability.html">here</a>. The most important part is the URL for accessing the receiver from the device. It can be either HTTP or HTTPS.
The configuration allows you to adjust the request size sent to the server and the timeout of the connection to the server.</p>

<p>What happens if device can not connect to receiver for a few days? The agent saves the timestamp of the last written metric. It will start writing from that point in time until all the metrics in the TSDB are written. Metrics that were deleted by TSDB retention before having a chance to send them are lost.</p>

<p>What happens to sent metrics? Saving the timestamp of last written metric avoids writing same metrics again. But who deletes these metrics? TSDB retention.</p>

<h2 id="example-of-thanos-receiver">Example of Thanos receiver</h2>

<p>The <a href="https://github.com/project-flotta/flotta-operator/blob/main/docs/user-guide/device-metrics.md">Device Metrics user guide</a> includes an example of a Thanos deployment in K8S. The example includes two deployments one with TLS and one without. The deployment has two servers (containers). One is the receiver. Another is the querier. Querier is used for reading the metrics that the receiver saved. Thanos supports PromQL so you can use it in Grafana. The querier has two address configurations. One, is the connection to the receiver. Another, is the HTTP address to listen for queries. The receiver also has two address configurations. One, is the server address for accepting connections from querier. Another, is the HTTP address that listens from remote writes.</p>

        </div>
      </div>
    </div>
  </div>
</section>



<!-- blog -->
<section class="section">
  <div class="container">
    <div class="row">
      <div class="col-12 text-center">
        <h2 class="section-title">Similar Stories</h2>
      </div>
      
      <div class="col-lg-4 col-sm-6 mb-4">
  <article class="card shadow">
    
    <div class="card-body">
      <h4 class="card-title">
        <a class="text-dark" href="/flotta/2022/09/28/run-ansible-playbooks.html">Running Ansible Playbooks on Edge Devices</a>
      </h4>
      <p class="card-text">There may be cases in which you would like to be able to execute a scripts or commands in a device or on a group of devices. For example, in...</p>
      <a href="/flotta/2022/09/28/run-ansible-playbooks.html" class="btn btn-xs btn-primary">Read More</a>
    </div>
  </article>
</div>

      
      <div class="col-lg-4 col-sm-6 mb-4">
  <article class="card shadow">
    
    <div class="card-body">
      <h4 class="card-title">
        <a class="text-dark" href="/flotta/2022/09/05/edge-example-app-sense-the-internet-part-2.html">Edge Example App: Sense the Internet Part 2</a>
      </h4>
      <p class="card-text">Edge Example App is an app for Flotta Edge devices, with a workload that will be deployed on the device that has two main features: Sensing the Internet (which helps...</p>
      <a href="/flotta/2022/09/05/edge-example-app-sense-the-internet-part-2.html" class="btn btn-xs btn-primary">Read More</a>
    </div>
  </article>
</div>

      
      <div class="col-lg-4 col-sm-6 mb-4">
  <article class="card shadow">
    
    <div class="card-body">
      <h4 class="card-title">
        <a class="text-dark" href="/flotta/2022/09/05/edge-example-app-cpu-temp.html">Edge Example App: CPU Temperature</a>
      </h4>
      <p class="card-text">Edge Example App is an app for Flotta Edge devices, with a workload that will be deployed on the device that has two main features:
</p>
      <a href="/flotta/2022/09/05/edge-example-app-cpu-temp.html" class="btn btn-xs btn-primary">Read More</a>
    </div>
  </article>
</div>

      
    </div>
  </div>
</section>
<!-- /blog -->


  <!-- footer -->
<footer class="bg-dark footer-section">
  <div class="section">
    <div class="container">
      <div class="row">
        <div class="col-md-4">
          <h5 class="text-light">Email</h5>
          <p class="text-white paragraph-lg font-secondary">flotta@redhat.com</p>
        </div>
        <div class="col-md-4">
          <h5><a href="http://www.redhat.com"><img id="sponsorship" class="footerLogo" src="/assets/images/Logo-Red_Hat-Supported_By-A-Reverse-RGB.svg"></a>.</h5>
        </div>
        <!-- <div class="col-md-4"> -->
        <!--   <h5 class="text-light">Address</h5> -->
        <!--   <p class="text-white paragraph-lg font-secondary"></p> -->
        <!-- </div> -->
      </div>
    </div>
  </div>
  <div class="border-top text-center border-dark py-5">
    <p class="mb-0 text-light"><p>Copyright © 2020 Designed by <a href="https://themefisher.com">Themefisher</a> &amp; Developed by <a href="https://getjekyllthemes.com">Getjekyllthemes</a></p>
</p>
  </div>
</footer>
<!-- /footer -->


<!-- JS Plugins -->

<script src="/assets/plugins/jQuery/jquery.min.js"></script>

<script src="/assets/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/assets/plugins/shuffle/shuffle.min.js"></script>

<script src="/assets/plugins/slick/slick.min.js"></script>


<!-- Main Script -->
<script src="/assets/js/script.js"></script>

<!-- This comes from DTM/DPAL and must be latest entry in body-->
<script type="text/javascript">
  if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
      _satellite.pageBottom();
  }
</script>


<script>
  $(function() {
    return $("h2, h3, h4, h5, h6").each(function(i, el) {
      var $el, icon, id;
      $el = $(el);
      id = $el.attr('id');
      icon = '<i class="ti-link"></i>';
      console.log("test test"+id)
      if (id) {
        return $el.prepend($("<a />").addClass("header-link").attr("href", "#" + id).html(icon));
      }
    });
  });
</script>


</body>

</html>
